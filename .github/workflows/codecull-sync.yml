name: CodeCull Sync

on:
  workflow_dispatch:
    inputs:
      dashboard_url:
        description: "CodeCull dashboard URL to trigger sync on"
        required: false
        default: "https://codecull-idduawlp.fly.dev"

jobs:
  trigger-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger sync via API
        env:
          DASHBOARD_URL: ${{ github.event.inputs.dashboard_url }}
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "$DASHBOARD_URL/api/sync" \
            -H "Authorization: Bearer ${{ secrets.SYNC_API_TOKEN }}")
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "::error::Sync trigger failed with HTTP $HTTP_CODE"
            exit 1
          fi

      - name: Poll sync status
        env:
          DASHBOARD_URL: ${{ github.event.inputs.dashboard_url }}
        run: |
          echo "Waiting for sync to complete..."
          for i in $(seq 1 120); do
            sleep 15
            RESPONSE=$(curl -s \
              "$DASHBOARD_URL/api/sync/status" \
              -H "Authorization: Bearer ${{ secrets.SYNC_API_TOKEN }}")
            RUNNING=$(echo "$RESPONSE" | jq -r '.running')
            echo "[$i/120] running=$RUNNING"
            if [ "$RUNNING" = "false" ]; then
              ERROR=$(echo "$RESPONSE" | jq -r '.error // empty')
              if [ -n "$ERROR" ]; then
                echo "::error::Sync failed: $ERROR"
                exit 1
              fi
              echo "Sync completed successfully!"
              echo "$RESPONSE" | jq .
              exit 0
            fi
          done
          echo "::error::Sync timed out after 30 minutes"
          exit 1
